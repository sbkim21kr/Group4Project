import time
import pymcprotocol
import DobotDllType as dType

# =========================================================
# CONFIGURATION
# =========================================================

# PLC ì„¤ì •
PLC_IP = "192.168.3.39"  # todo ip í™•ì¸ í•„ìš”
PLC_PORT = 5051          # todo í¬í†  í™•ì¸ í•„ìš”
PLC_TIMEOUT = 5.0

# Dobot ê³µí†µ ì„¤ì •
BAUDRATE = 115200
DOBOT_VELOCITY = 50.0
DOBOT_ACCELERATION = 50.0


# ìˆ˜ëŸ‰
P_COUNT = 0
F_COUNT = 0

# =========================================================
# ë¡œë´‡ë³„ WAYPOINTS
# Format: (X, Y, Z, R, Velocity, Accel, Suction, Dwell)
# =========================================================

   # todo ìœ„ì¹˜ ê°’ í™•ì¸ í•„ìš”
WAYPOINTS_R1 = [

    # (160.3320,-142.4082,-4.6885,-41.6118,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    # (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,1,1.0000),
    # (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,1,1.0000),
    # (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    # (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    # (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    # (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    # (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,0,1.0000),
    # (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,0,1.0000),
    # (160.3320,-142.4082,-4.6885,-41.6118,0.0000,0.0000,0,1.0000)

    (174.8187,-107.0179,-18.7913,-31.4735,0.0000,0.0000,1,1.0000),
    (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,1,1.0000),
    (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,1,1.0000),
    (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,0,1.0000),
    (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,0,1.0000),
    (174.8187,-107.0179,-18.7913,-31.4735,0.0000,0.0000,1,1.0000)



    # (174.8187,-107.0179,-18.7913,-31.4735,0.0000,0.0000,0,1.0000),
    # (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-58.7801,-89.1530,0.0000,0.0000,1,1.0000),
    # (3.3185,-224.4474,-12.3084,-89.1530,0.0000,0.0000,1,1.0000),
    # (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,1,1.0000),
    # (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,1,1.0000),
    # (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    # (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    # (271.7672,60.6154,100.0000,12.5735,0.0000,0.0000,1,1.0000),
    # (269.9418,56.6832,125.1828,11.8588,0.0000,0.0000,1,1.0000),
    # (192.7760,50.7326,126.1451,14.7441,0.0000,0.0000,0,1.0000),
    # (183.3598,-121.6611,100.2848,-33.5647,0.0000,0.0000,0,1.0000),
    # (174.8187,-107.0179,-18.7913,-31.4735,0.0000,0.0000,0,1.0000)
]







WAYPOINTS_R2 = [
    (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,0,1.0000),
    (20.7854,252.1811,60.0000,120.0000,0.0000,0.0000,0,1.0000),
    (20.7854,252.1811,15.0000,120.0000,0.0000,0.0000,0,2.0000),
    (20.7854,252.1811,15.0000,120.0000,0.0000,0.0000,1,2.0000),
    (20.7854,252.1811,60.0000,120.0000,0.0000,0.0000,1,1.0000),
    (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,1,1.0000),
    (121.9720,200.0000,20.0000,-90.0000,0.0000,0.0000,1,1.0000),
    (202.8835,122.9131,45.0000,-118.7912,0.0000,0.0000,1,1.0000),
    (202.8835,122.9131,11.5000,-118.7912,0.0000,0.0000,1,1.0000),
    (202.8835,122.9131,11.5000,-118.7912,0.0000,0.0000,1,2.0000),
    (202.8835,122.9131,60.0000,-118.7912,0.0000,0.0000,0,1.0000),
    (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,0,0.0000)


    # (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,0,1.0000),
    # (26.0072,255.6424,60.0000,119.2200,0.0000,0.0000,0,1.0000),
    # (26.0072,255.6424,26.1164,119.2200,0.5000,0.5000,0,1.0000),
    # (26.0072,255.6424,26.1164,119.2200,0.5000,0.5000,1,1.0000),
    # (26.0072,255.6424,60.0000,119.2200,0.0000,0.0000,1,1.0000),
    # (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,1,1.0000),
    # (121.9720,200.0000,20.0000,-90.0000,0.0000,0.0000,1,1.0000),
    # (202.8835,122.9131,45.0000,-118.7912,0.0000,0.0000,1,1.0000),
    # (202.8835,122.9131,11.5000,-118.7912,0.5000,0.5000,1,1.0000),
    # (202.8835,122.9131,11.5000,-118.7912,0.5000,0.5000,1,1.0000),
    # (202.8835,122.9131,60.0000,-118.7912,0.0000,0.0000,0,1.0000),
    # (121.9720,200.0000,20.0000,80.0000,0.0000,0.0000,0,1.0000)


]







WAYPOINTS_R3 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,1,1.0000),
    (-4.0000,216.2137,66.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,66.0000,90.5294,0.0000,0.0000,1,2.0000),
    (-4.0000,265.8454,66.0000,90.5294,0.0000,0.0000,1,2.0000),
    (-4.0000,216.2137,75.0000,90.5294,0.0000,0.0000,0,2.0000),
    (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,0,1.0000)
]

WAYPOINTS_R3_P_1 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,104.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,1,1.0000),
    (-4.0000,216.2137,66.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,66.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,75.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,216.2137,75.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,0,1.0000)


    # (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000),
    # (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,0,1.0000),
    # (182.7741,-216.6221,104.0000,-49.8441,0.5000,0.5000,0,1.0000),
    # (182.7741,-216.6221,104.0000,-49.8441,0.5000,0.5000,1,1.0000),
    # (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    # (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    # (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,1,1.0000),
    # (-4.0000,216.2137,66.0000,90.5294,0.0000,0.0000,1,1.0000),
    # (-4.0000,265.8454,66.0000,90.5294,0.0000,0.0000,1,1.0000),
    # (-4.0000,265.8454,66.0000,90.5294,0.5000,0.5000,1,1.0000),
    # (-4.0000,265.8454,66.0000,90.5294,0.5000,0.5000,0,1.0000),
    # (-4.0000,265.8454,75.0000,90.5294,0.0000,0.0000,0,1.0000),
    # (-4.0000,216.2137,75.0000,90.5294,0.0000,0.0000,0,1.0000),
    # (-4.0000,198.2113,106.5617,90.7147,0.0000,0.0000,0,1.0000),
    # (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000)



















]

WAYPOINTS_R3_P_2 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (-4.0000,198.2113,105.0000,90.7147,0.0000,0.0000,1,1.0000),
    (-4.0000,216.2137,88.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,88.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,98.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,216.2137,98.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,198.2113,105.0000,90.7147,0.0000,0.0000,0,1.0000)

]

WAYPOINTS_R3_P_3 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (-4.0000,198.2113,105.0000,90.7147,0.0000,0.0000,1,1.0000),
    (-4.0000,216.2137,105.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,105.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,265.8454,115.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,216.2137,115.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,198.2113,105.0000,90.7147,0.0000,0.0000,0,1.0000)


]

WAYPOINTS_R3_P_4 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,106.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (182.7741,-216.6221,130.0000,-49.8441,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (-4.0000,198.2113,125.0000,90.7147,0.0000,0.0000,1,1.0000),
    (-4.0000,216.2137,125.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,125.0000,90.5294,0.0000,0.0000,1,1.0000),
    (-4.0000,265.8454,125.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,265.8454,135.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,216.2137,135.0000,90.5294,0.0000,0.0000,0,1.0000),
    (-4.0000,198.2113,105.0000,90.7147,0.0000,0.0000,0,1.0000)
]

WAYPOINTS_R3_F_1 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,105.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,106.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,1,1.0000),
    (174.0000,216.1578,70.0000,51.0882,0.0000,0.0000,1,1.0000),
    (174.0000,216.1578,50.0000,51.0882,0.0000,0.0000,1,1.0000),
    (174.0000,216.1578,50.0000,50.7971,0.0000,0.0000,0,1.0000),
    (174.0000,216.1578,70.0000,50.7971,0.0000,0.0000,0,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,0,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000)
]

WAYPOINTS_R3_F_2 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,105.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,106.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,1,1.0000),
    (174.0000,168.6352,70.0000,44.3647,0.0000,0.0000,1,1.0000),
    (174.0000,168.6352,50.0000,44.3647,0.0000,0.0000,1,1.0000),
    (174.0000,168.6352,50.0000,44.3647,0.0000,0.0000,0,1.0000),
    (174.0000,168.6352,70.0000,44.3647,0.0000,0.0000,0,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,0,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000)

]

WAYPOINTS_R3_F_3 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,105.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,106.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,1,1.0000),
    (128.5163,217.0803,70.0000,59.3735,0.0000,0.0000,1,1.0000),
    (128.5163,217.0803,50.0000,59.3735,0.0000,0.0000,1,1.0000),
    (128.5163,217.0803,50.0000,59.3735,0.0000,0.0000,0,1.0000),
    (128.5163,217.0803,70.0000,59.3735,0.0000,0.0000,0,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,0,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000)


]

WAYPOINTS_R3_F_4 = [
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,105.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,106.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (185.0000,-219.2628,130.0000,-49.5794,0.0000,0.0000,1,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,1,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,1,1.0000),
    (128.5163,168.5904,70.0000,59.3735,0.0000,0.0000,1,1.0000),
    (128.5163,168.5904,50.0000,59.3735,0.0000,0.0000,1,1.0000),
    (128.5163,168.5904,50.0000,59.3735,0.0000,0.0000,0,1.0000),
    (128.5163,168.5904,70.0000,59.3735,0.0000,0.0000,0,1.0000),
    (148.4251,168.0421,132.4263,48.5471,0.0000,0.0000,0,1.0000),
    (243.9223,-31.1581,130.0000,-7.2794,0.0000,0.0000,0,1.0000)


]


# =========================================================
# ë¡œë´‡ë³„ ë§¤í•‘ (í¬íŠ¸ + Më¹„íŠ¸)
# ğŸ‘‰ ì—¬ê¸°ì—ì„œ COM3/COM4/COM5/COM6 ì‹¤ì œ í¬íŠ¸ì— ë§ê²Œ ìˆ˜ì •!
# =========================================================

ROBOT_CONFIGS = [
    {
        "name": "R1",
        "port": "COM12",     # todo í¬í†  í™•ì¸ í•„ìš”
        "start_bit": "M100",
        "busy_bit":  "M101",
        "done_bit":  "M102",
        "waypoints": WAYPOINTS_R1,
    },
    {
        "name": "R2",
        "port": "COM3",      # todo í¬í†  í™•ì¸ í•„ìš”
        "start_bit": "M200",
        "busy_bit":  "M201",
        "done_bit":  "M202",
        "waypoints": WAYPOINTS_R2,
    },
    {
        "name": "R3",
        "port": "COM11",   # todo í¬í†  í™•ì¸ í•„ìš”
        "start_bit": "M300",
        "busy_bit":  "M301",
        "done_bit":  "M302",
        "waypoints": WAYPOINTS_R3,
    },
]

# =========================================================
# PLC FUNCTIONS
# =========================================================

def connect_plc():
    mc = pymcprotocol.Type3E()
    mc.timeout = PLC_TIMEOUT
    while True:
        try:
            print(f"[PLC] Trying {PLC_IP}:{PLC_PORT}...")
            mc.connect(PLC_IP, PLC_PORT)
            print(f"[PLC] Connected to {PLC_IP}:{PLC_PORT}")
            return mc
        except Exception as e:
            print(f"[PLC] Connection Error: {e}")
            time.sleep(2)

def set_plc_bit(mc, address, value, tag=""):
    try:
        mc.batchwrite_bitunits(headdevice=address, values=[value])
        print(f"[PLC{tag}] {address} = {'ON' if value else 'OFF'}")
    except Exception as e:
        print(f"[PLC{tag}] Error setting {address} to {value}: {e}")

def pulse_plc_bit(mc, address, on_time=0.2, off_time=0.2, tag=""):
    try:
        mc.batchwrite_bitunits(headdevice=address, values=[1])
        print(f"[PLC{tag}] Pulse {address} â†’ ON {on_time}s")
        time.sleep(on_time)
        mc.batchwrite_bitunits(headdevice=address, values=[0])
        print(f"[PLC{tag}] Pulse {address} â†’ OFF {off_time}s")
        time.sleep(off_time)
    except Exception as e:
        print(f"[PLC{tag}] Error pulsing {address}: {e}")

def read_plc_bit(mc, address, tag=""):
    try:
        val = mc.batchread_bitunits(headdevice=address, readsize=1)[0]
        #print(f"[PLC{tag}] val : {val}")
        return int(val)
    except Exception as e:
        print(f"[PLC{tag}] Error reading {address}: {e}")
        return 0

# =========================================================
# DOBOT FUNCTIONS
# =========================================================

def run_dobot_sequence(api, waypoints, name=""):
    print(f"[{name}][DOBOT] Direct (non-queued) sequence start...")

    # í˜¹ì‹œ ì‹¤í–‰ ì¤‘ì´ë˜ ê²ƒë“¤ ì •ë¦¬
    reset_dobot_state(api, name=name)

    # ê¸°ë³¸ PTP íŒŒë¼ë¯¸í„°
    dType.SetPTPCommonParams(api, DOBOT_VELOCITY, DOBOT_ACCELERATION)
    dType.SetPTPCoordinateParams(
        api,
        DOBOT_VELOCITY, DOBOT_ACCELERATION,
        DOBOT_VELOCITY, DOBOT_ACCELERATION,
        isQueued=0,
    )

    for i, (x, y, z, r, vel, accel, suction, dwell) in enumerate(waypoints, start=1):
        # í¬ì¸íŠ¸ë³„ ì†ë„ ì ìš© (0ì´ë©´ ê¸€ë¡œë²Œ ê°’ ì‚¬ìš©)
        v = vel if vel > 0 else DOBOT_VELOCITY
        a = accel if accel > 0 else DOBOT_ACCELERATION
        dType.SetPTPCommonParams(api, v, a)

        print(f"[{name}][DOBOT] MOVE P{i}: "
              f"X={x},Y={y},Z={z},R={r},Suc={suction},Dw={dwell}")

        # â˜… íì— ë„£ì§€ ì•Šê³  ë°”ë¡œ ì‹¤í–‰ (isQueued=0)
        ret = dType.SetPTPCmd(
            api,
            dType.PTPMode.PTPMOVJXYZMode,
            x, y, z, r,
            isQueued=0
        )
        print(f"[{name}][DOBOT] SetPTPCmd ret={ret}")

        # í¡ì°© or ê·¸ë¦¬í¼
        if (name == "R2"):
            dType.SetEndEffectorGripper(api, 1, suction, 0)
        else:
            dType.SetEndEffectorSuctionCup(api, 1, suction, 0)
        

        # dwell ë™ì•ˆ ê¸°ë‹¤ë¦¬ê¸° (ë™ê¸°)
        if dwell > 0:
            time.sleep(dwell)

    print(f"[{name}][DOBOT] Direct sequence end.")


def reset_dobot_state(api, name=""):
    tag = f"[{name}][RESET]" if name else "[RESET]"
    try:
        # ì‹¤í–‰ ì¤‘ì´ë©´ ê°•ì œ ì •ì§€ + ì •ì§€
        dType.SetQueuedCmdForceStopExec(api)
        dType.SetQueuedCmdStopExec(api)

        # í í´ë¦¬ì–´
        dType.SetQueuedCmdClear(api)
        dType.SetQueuedCmdStartExec(api)

        # (ì„ íƒ) í™ˆ ëª…ë ¹ì„ í ì—†ì´ í•œ ë²ˆ ë‚ ë ¤ì„œ
        # ë‚´ë¶€ ìƒíƒœê°€ ì •ìƒì ìœ¼ë¡œ ëª…ë ¹ì„ ë°›ëŠ”ì§€ í™•ì¸
        # temp íŒŒë¼ë¯¸í„° í•„ìˆ˜!
        # í•„ìš” ì—†ìœ¼ë©´ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë¨
        # dType.SetHOMECmd(api, temp=0, isQueued=0)

        # ë””ë²„ê·¸ ì¶œë ¥
        cur = dType.GetQueuedCmdCurrentIndex(api)[0]
        print(f"{tag} Queue cleared. currentIndex={cur}")
    except Exception as e:
        print(f"{tag} ERROR while reset: {e}")



# =========================================================
# ë¡œë´‡ 1ì‹¸ì´í´ ì²˜ë¦¬: Connect â†’ Run â†’ Done â†’ Disconnect
# =========================================================

def handle_robot_cycle(api, mc, cfg):
    name      = cfg["name"]
    port      = cfg["port"]
    start_bit = cfg["start_bit"]
    busy_bit  = cfg["busy_bit"]
    done_bit  = cfg["done_bit"]
    waypoints = cfg["waypoints"]
    tag = f"-{name}"

    global F_COUNT
    global P_COUNT

    isEmpty = False

    print(f"\n[{name}] ===== CYCLE START (trigger: {start_bit}) =====")

    # 1) Dobot Connect
    state = dType.ConnectDobot(api, port, BAUDRATE)[0]
    if state != dType.DobotConnect.DobotConnect_NoError:
        print(f"[{name}] ERROR: Could not connect to Dobot on {port}, state={state}")
        # ì‹¤íŒ¨í–ˆì–´ë„ PLC ìª½ì—ì„œëŠ” ë­”ê°€ ì‘ë‹µì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ done í„ìŠ¤ ì¤„ì§€ ê²°ì •
        pulse_plc_bit(mc, done_bit, tag=tag)
        return

    print(f"[{name}] Dobot Connected on {port}")

    # â˜… ì—¬ê¸°ì„œ ë‚´ë¶€ í ì™„ì „ ë¦¬ì…‹
    reset_dobot_state(api, name=name)

    dType.SetPTPCommonParams(api, DOBOT_VELOCITY, DOBOT_ACCELERATION)
    dType.SetPTPCoordinateParams(api, DOBOT_VELOCITY, DOBOT_ACCELERATION,
                                 DOBOT_VELOCITY, DOBOT_ACCELERATION, isQueued=0)

    m403 = read_plc_bit(mc, "M403", tag="P")
    m404 = read_plc_bit(mc, "M404", tag="F")
    print(f"[{name}] m403 = [{m403}] P_COUNT : [{P_COUNT}]")
    print(f"[{name}] m404 = [{m404}]  F_COUNT : [{F_COUNT}]")
    
    if (name == "R3"):
        if (m403 == 0 and m404 == 0): 
            isEmpty = True
        if (m403 == 1 and P_COUNT == 0):
            waypoints = WAYPOINTS_R3_P_1
            P_COUNT += 1
        elif (m403 == 1 and P_COUNT == 1):
            waypoints = WAYPOINTS_R3_P_2
            P_COUNT += 1
        elif (m403 == 1 and P_COUNT == 2):
            waypoints = WAYPOINTS_R3_P_3
            P_COUNT += 1
        elif (m403 == 1 and P_COUNT == 3):
            waypoints = WAYPOINTS_R3_P_4
            P_COUNT += 1
        if (m404 == 1 and F_COUNT == 0):
            waypoints = WAYPOINTS_R3_F_1
            F_COUNT += 1
        elif (m404 == 1 and F_COUNT == 1):
            waypoints = WAYPOINTS_R3_F_2
            F_COUNT += 1
        elif (m404 == 1 and F_COUNT == 2):
            waypoints = WAYPOINTS_R3_F_3
            F_COUNT += 1
        elif (m404 == 1 and F_COUNT == 3):
            waypoints = WAYPOINTS_R3_F_4
            F_COUNT += 1
        

    # 2) Busy ON
    set_plc_bit(mc, busy_bit, 1, tag=tag)

    set_plc_bit(mc, "M403", 0, tag="m403 ì´ˆê¸°í™”")
    set_plc_bit(mc, "M404", 0, tag="m404 ì´ˆê¸°í™”")
    # 3) ì‹œí€€ìŠ¤ ì‹¤í–‰
    try:
        if (isEmpty == False):
            run_dobot_sequence(api, waypoints, name=name)
    except Exception as e:
        print(f"[{name}] ERROR in sequence: {e}")

    # 4) Busy OFF + Done í„ìŠ¤
    set_plc_bit(mc, busy_bit, 0, tag=tag)
    pulse_plc_bit(mc, done_bit, tag=tag)

    # 5) ì¢…ë£Œ ì „ì— í•œ ë²ˆ ë” í ì •ë¦¬(í˜¹ì‹œë¼ë„ ë‚¨ì€ ê±° ë°©ì§€)
    reset_dobot_state(api, name=name)

    # 6) Dobot Disconnect
    try:
        dType.DisconnectDobot(api)
        print(f"[{name}] Dobot Disconnected from {port}")
    except Exception as e:
        print(f"[{name}] Error during Disconnect: {e}")

    print(f"[{name}] Cycle finished. Ready for next trigger (when PLC sets {start_bit} again).")
    print(f"[{name}] ===== CYCLE END =====\n")

# =========================================================
# MAIN LOOP
# =========================================================

def main():
    # Dobot DLL ë¡œë“œ (í•¸ë“¤ í•˜ë‚˜ë§Œ ì‚¬ìš©)
    api = dType.load()

    # PLC ì—°ê²°
    mc = connect_plc()
    set_plc_bit(mc, "M100", 0, tag="-R1")
    set_plc_bit(mc, "M200", 0, tag="-R2")
    set_plc_bit(mc, "M300", 0, tag="-R3")
    set_plc_bit(mc, "M101", 0, tag="-R1")
    set_plc_bit(mc, "M201", 0, tag="-R2")
    set_plc_bit(mc, "M301", 0, tag="-R3")
    set_plc_bit(mc, "M102", 0, tag="-R1")
    set_plc_bit(mc, "M202", 0, tag="-R2")
    set_plc_bit(mc, "M302", 0, tag="-R3")

    # ì—ì§€ ê²€ì¶œìš© ì´ì „ê°’
    prev_m100 = prev_m200 = prev_m300 = 0

    print("\n[SYSTEM] Multi-robot Dobot (connect per trigger) started.")
    print("[SYSTEM] Waiting for M100 / M200 / M300 ...\n")

    try:
        while True:
            # 1) PLC ë¹„íŠ¸ ë¨¼ì € ë‹¤ ì½ê¸°
            m100 = read_plc_bit(mc, "M100", tag="-R1")
            m101 = read_plc_bit(mc, "M101", tag="-R1_move")
            m200 = read_plc_bit(mc, "M200", tag="-R2")
            m201 = read_plc_bit(mc, "M201", tag="-R2_move")
            m300 = read_plc_bit(mc, "M300", tag="-R3")
            m301 = read_plc_bit(mc, "M301", tag="-R3_move")

            all_idle = (m101 == 0 and m201 == 0 and m301 == 0)

            # R1: 0â†’1 ìƒìŠ¹ ì—ì§€ + idleì¼ ë•Œë§Œ
            if all_idle and prev_m100 == 0 and m100 == 1:
                print("[R1] M100 rising edge â†’ R1 cycle start")
                handle_robot_cycle(api, mc, ROBOT_CONFIGS[0])

            # R2
            elif all_idle and prev_m200 == 0 and m200 == 1:
                print("[R2] M200 rising edge â†’ R2 cycle start")
                handle_robot_cycle(api, mc, ROBOT_CONFIGS[1])

            # R3
            elif all_idle and prev_m300 == 0 and m300 == 1:
                print("[R3] M300 rising edge â†’ R3 cycle start")
                handle_robot_cycle(api, mc, ROBOT_CONFIGS[2])

            prev_m100 = m100
            prev_m200 = m200
            prev_m300 = m300

            time.sleep(0.1)

    except KeyboardInterrupt:
        print("\n[SYSTEM] KeyboardInterrupt, shutting down...")
    finally:
        try:
            mc.close()
        except:
            pass
        try:
            dType.DisconnectDobot(api)
        except:
            pass
        print("[SYSTEM] All connections closed. Bye.")

if __name__ == "__main__":
    main()